<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadistiques - MENAG Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #E07A2F;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .nav a {
            color: #E07A2F;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        .nav a:hover { background: #fff5ef; }
        .nav a.active { background: #E07A2F; color: white; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #E07A2F;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .cost-highlight {
            background: linear-gradient(135deg, #E07A2F 0%, #f5a623 100%);
        }
        .cost-highlight .stat-value { color: white; }
        .cost-highlight .stat-label { color: rgba(255,255,255,0.8); }
        h2 {
            color: #333;
            margin: 30px 0 15px;
            font-size: 1.3em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        .model-name {
            font-family: monospace;
            font-size: 12px;
        }
        .token-count {
            font-family: monospace;
            color: #666;
        }
        .cost {
            font-weight: 600;
            color: #E07A2F;
        }
        .recent-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .recent-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .recent-item:last-child { border-bottom: none; }
        .recent-info {
            flex: 1;
        }
        .recent-operation {
            font-weight: 600;
            color: #333;
        }
        .recent-meta {
            font-size: 12px;
            color: #666;
        }
        .recent-cost {
            font-weight: 600;
            color: #E07A2F;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Estadistiques d'Us</h1>
            <p class="subtitle">Seguiment de tokens i costos</p>

            <nav class="nav">
                <a href="/">Generador</a>
                <a href="/settings">Configuracio</a>
                <a href="/stats" class="active">Estadistiques</a>
            </nav>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalPresentations">0</div>
                    <div class="stat-label">Presentacions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSessions">0</div>
                    <div class="stat-label">Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalImages">0</div>
                    <div class="stat-label">Imatges</div>
                </div>
                <div class="stat-card cost-highlight">
                    <div class="stat-value" id="totalCost">$0.00</div>
                    <div class="stat-label">Cost Total</div>
                </div>
            </div>

            <h2>Us per Model</h2>
            <table id="modelTable">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th>Input Tokens</th>
                        <th>Output Tokens</th>
                        <th>Imatges</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody id="modelTableBody">
                    <tr><td colspan="5" class="empty-state">Carregant...</td></tr>
                </tbody>
            </table>

            <h2>Usuaris</h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Presentacions</th>
                        <th>Cost Total</th>
                        <th>Des de</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr><td colspan="4" class="empty-state">Carregant...</td></tr>
                </tbody>
            </table>

            <h2>Operacions Recents</h2>
            <div class="recent-list" id="recentList">
                <div class="empty-state">Carregant...</div>
            </div>
        </div>
    </div>

    <script>
        function formatNumber(num) {
            return new Intl.NumberFormat('ca-ES').format(num || 0);
        }

        function formatCost(cost) {
            return '$' + (cost || 0).toFixed(4);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ca-ES', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                // Actualitzar totals
                document.getElementById('totalPresentations').textContent = formatNumber(data.total_presentations);
                document.getElementById('totalSessions').textContent = formatNumber(data.total_sessions);
                document.getElementById('totalImages').textContent = formatNumber(data.total_images_generated);
                document.getElementById('totalCost').textContent = formatCost(data.total_cost_usd);

                // Taula per model
                const tbody = document.getElementById('modelTableBody');
                if (data.by_model && data.by_model.length > 0) {
                    tbody.innerHTML = data.by_model.map(m => `
                        <tr>
                            <td class="model-name">${m.model}</td>
                            <td class="token-count">${formatNumber(m.input_tokens)}</td>
                            <td class="token-count">${formatNumber(m.output_tokens)}</td>
                            <td class="token-count">${formatNumber(m.images_generated)}</td>
                            <td class="cost">${formatCost(m.cost_usd)}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Encara no hi ha dades</td></tr>';
                }

                // Taula d'usuaris
                const usersBody = document.getElementById('usersTableBody');
                if (data.users && data.users.length > 0) {
                    usersBody.innerHTML = data.users.map(u => `
                        <tr>
                            <td><strong>${u.name}</strong></td>
                            <td>${formatNumber(u.presentations_generated)}</td>
                            <td class="cost">${formatCost(u.total_cost_usd)}</td>
                            <td>${formatDate(u.created_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    usersBody.innerHTML = '<tr><td colspan="4" class="empty-state">Encara no hi ha usuaris</td></tr>';
                }

                // Operacions recents
                const recentList = document.getElementById('recentList');
                if (data.recent_operations && data.recent_operations.length > 0) {
                    recentList.innerHTML = data.recent_operations.map(op => `
                        <div class="recent-item">
                            <div class="recent-info">
                                <div class="recent-operation">${op.operation}</div>
                                <div class="recent-meta">
                                    ${op.model} | ${op.chapter_name || '-'} | ${formatDate(op.created_at)}
                                </div>
                            </div>
                            <div class="recent-cost">${formatCost(op.cost_usd)}</div>
                        </div>
                    `).join('');
                } else {
                    recentList.innerHTML = '<div class="empty-state">Encara no hi ha operacions</div>';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        loadStats();
        // Actualitzar cada 30 segons
        setInterval(loadStats, 30000);
    </script>
</body>
</html>
